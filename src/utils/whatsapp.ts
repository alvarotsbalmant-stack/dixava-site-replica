
import { supabase } from '@/integrations/supabase/client';
import { sendOrderCreatedEmail } from './orderEmailService';

export const generateOrderVerificationCode = async (cartItems: any[], total: number) => {
  console.log('üîê generateOrderVerificationCode called with items:', cartItems.length, 'total:', total);
  
  try {
    // Preparar dados dos itens
    const items = cartItems.map(item => ({
      product_id: item.product.id,
      product_name: item.product.name,
      quantity: item.quantity,
      price: item.product.price,
      size: item.size,
      color: item.color,
      total: item.product.price * item.quantity
    }));
    console.log('üì¶ Items prepared:', items);

    // Preparar dados do cliente
    const customerInfo = {
      timestamp: new Date().toISOString(),
      browser: navigator.userAgent
    };
    console.log('üë§ Customer info prepared:', customerInfo);

    // Obter dados do usu√°rio se logado
    console.log('üîç Getting user data...');
    const { data: { user } } = await supabase.auth.getUser();
    console.log('üë§ User:', user?.id || 'not logged in');

    // Chamar fun√ß√£o do Supabase
    console.log('üìû Calling supabase RPC create_order_verification_code...');
    const { data, error } = await supabase.rpc('create_order_verification_code', {
      p_user_id: user?.id || null,
      p_items: items,
      p_total_amount: total,
      p_customer_info: customerInfo,
      p_browser_info: { userAgent: navigator.userAgent }
    });

    if (error) {
      console.error('‚ùå Supabase RPC error:', error);
      throw error;
    }
    console.log('‚úÖ Supabase RPC response:', data);

    const result = data as any;
    if (result?.success) {
      console.log('‚úÖ Code generated successfully:', result.code);
      return result.code;
    } else {
      console.error('‚ùå RPC returned error:', result?.message);
      throw new Error(result?.message || 'Erro ao gerar c√≥digo');
    }
  } catch (err) {
    console.error('‚ùå Error in generateOrderVerificationCode:', err);
    return null;
  }
};

// Fun√ß√£o para detectar se √© mobile
const isMobile = () => {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
};

// Fun√ß√£o para detectar se √© iOS
const isIOS = () => {
  return /iPad|iPhone|iPod/.test(navigator.userAgent);
};

// Fun√ß√£o robusta para redirecionamento WhatsApp
const openWhatsApp = (url: string, onLoadingStart?: () => void) => {
  const mobile = isMobile();
  const ios = isIOS();
  
  console.log('Abrindo WhatsApp:', { mobile, ios, url });
  
  // Ativar loading se callback fornecido
  if (onLoadingStart) {
    onLoadingStart();
  }
  
  if (mobile) {
    // Em mobile, usar window.location.href √© mais confi√°vel
    try {
      // Tentar abrir diretamente
      window.location.href = url;
    } catch (error) {
      console.error('Erro ao abrir WhatsApp via location.href:', error);
      // Fallback: tentar window.open
      try {
        const newWindow = window.open(url, '_blank');
        if (!newWindow) {
          // Se window.open falhou, mostrar link para o usu√°rio
          showWhatsAppFallback(url);
        }
      } catch (error2) {
        console.error('Erro ao abrir WhatsApp via window.open:', error2);
        // Fallback simples sem popup
        window.location.href = url;
      }
    }
  } else {
    // Em desktop, tentar window.open primeiro
    try {
      const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
      
      // Verificar se o popup foi bloqueado
      if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
        console.warn('Popup bloqueado, usando fallback');
        showWhatsAppFallback(url);
      } else {
        // Verificar se a janela ainda est√° aberta ap√≥s um tempo
        setTimeout(() => {
          try {
            if (newWindow.closed) {
              console.log('Janela foi fechada pelo usu√°rio');
            }
          } catch (e) {
            // Ignorar erros de cross-origin
          }
        }, 1000);
      }
    } catch (error) {
      console.error('Erro ao abrir WhatsApp via window.open:', error);
      showWhatsAppFallback(url);
    }
  }
};

// Fun√ß√£o para mostrar fallback profissional quando o redirecionamento autom√°tico falha
const showWhatsAppFallback = (url: string) => {
  // Criar overlay escuro
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    backdrop-filter: blur(2px);
  `;
  
  // Criar modal profissional
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e0e0e0;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    text-align: center;
    max-width: 420px;
    width: 90%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    animation: modalSlideIn 0.3s ease-out;
  `;
  
  // Adicionar anima√ß√£o CSS
  const style = document.createElement('style');
  style.textContent = `
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
  `;
  document.head.appendChild(style);
  
  modal.innerHTML = `
    <div style="margin-bottom: 24px;">
      <div style="
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        border-radius: 50%;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 8px 24px rgba(220, 38, 38, 0.3);
      ">
        üéÆ
      </div>
      <h3 style="
        color: #1f2937;
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 8px 0;
        line-height: 1.3;
      ">N√£o foi redirecionado?</h3>
      <p style="
        color: #6b7280;
        font-size: 14px;
        margin: 0;
        line-height: 1.5;
      ">Clique no bot√£o abaixo para finalizar seu pedido no WhatsApp</p>
    </div>
    
    <div style="margin-bottom: 24px;">
      <a href="${url}" target="_blank" style="
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        padding: 14px 28px;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        border: none;
        cursor: pointer;
        width: 100%;
        max-width: 280px;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 38, 38, 0.4)'" 
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(220, 38, 38, 0.3)'">
        <span style="font-size: 20px;">üí¨</span>
        Abrir WhatsApp
      </a>
    </div>
    
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
      font-size: 12px;
      color: #6b7280;
    ">
      <span style="color: #dc2626;">üîí</span>
      <span>Conex√£o segura ‚Ä¢ UTI dos Games</span>
    </div>
    
    <button onclick="this.closest('.whatsapp-fallback-overlay').remove()" style="
      background: transparent;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
      Fechar
    </button>
  `;
  
  // Adicionar classes para identifica√ß√£o
  overlay.className = 'whatsapp-fallback-overlay';
  modal.className = 'whatsapp-fallback-modal';
  
  // Adicionar ao DOM
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Fechar ao clicar no overlay
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
  
  // Remover automaticamente ap√≥s 15 segundos
  setTimeout(() => {
    if (overlay.parentElement) {
      overlay.remove();
    }
  }, 15000);
  
  // Cleanup do style quando remover
  overlay.addEventListener('remove', () => {
    if (style.parentElement) {
      style.remove();
    }
  });
};

export const sendToWhatsApp = async (cartItems: any[], phoneNumber: string = '5527996882090', trackWhatsAppClick?: (context?: string) => void, onLoadingStart?: () => void) => {
  console.log('üì¶ sendToWhatsApp utils called with:', cartItems.length, 'items');
  
  const itemsList = cartItems.map(item => 
    `‚Ä¢ ${item.product.name} (${item.size}${item.color ? `, ${item.color}` : ''}) - Qtd: ${item.quantity} - R$ ${(item.product.price * item.quantity).toFixed(2)}`
  ).join('\n');
  
  const total = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
  console.log('üí∞ Total calculated:', total);
  
  // Gerar c√≥digo de verifica√ß√£o do pedido
  console.log('üîê Generating order code...');
  const orderCode = await generateOrderVerificationCode(cartItems, total);
  
  if (!orderCode) {
    console.error('‚ùå Failed to generate order code');
    return null;
  }
  console.log('‚úÖ Order code generated:', orderCode);

  // Enviar email de confirma√ß√£o se o usu√°rio estiver logado
  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (user?.email) {
      console.log('üìß Sending email to:', user.email);
      await sendOrderCreatedEmail(
        user.email,
        user.user_metadata?.name || 'Cliente',
        orderCode
      );
    }
  } catch (err) {
    console.warn('üìß Email sending failed:', err);
  }
  
  const message = `Ol√°! Gostaria de pedir os seguintes itens da UTI DOS GAMES:\n\n${itemsList}\n\n*Total: R$ ${total.toFixed(2)}*\n\nüîê *C√≥digo de Verifica√ß√£o:*\n${orderCode}\n\nüìã *Copie o c√≥digo:*\n${orderCode}\n\nAguardo retorno! üéÆ`;
  
  // Track WhatsApp click if tracking function is provided
  if (trackWhatsAppClick) {
    console.log('üìä Tracking WhatsApp click');
    trackWhatsAppClick('cart_checkout');
  }

  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
  console.log('üöÄ Opening WhatsApp with URL length:', whatsappUrl.length);
  
  // Usar fun√ß√£o robusta para abrir WhatsApp com loading
  openWhatsApp(whatsappUrl, onLoadingStart);
  
  console.log('‚úÖ WhatsApp process completed, returning code:', orderCode);
  return orderCode;
};

// Fun√ß√£o para gerar c√≥digo de um √∫nico produto
export const generateSingleProductCode = async (product: any, quantity: number = 1, additionalInfo?: any) => {
  console.log('üîë [MOBILE DEBUG] generateSingleProductCode called:', {
    productName: product.name,
    quantity: quantity,
    additionalInfo: additionalInfo
  });
  
  const cartItems = [{
    product: product,
    quantity: quantity,
    size: additionalInfo?.size,
    color: additionalInfo?.color
  }];
  
  const total = product.price * quantity;
  console.log('üìä [MOBILE DEBUG] Cart items prepared:', cartItems);
  console.log('üí∞ [MOBILE DEBUG] Total calculated:', total);
  
  return await generateOrderVerificationCode(cartItems, total);
};

// Fun√ß√£o para compra direta com c√≥digo de verifica√ß√£o
export const sendSingleProductToWhatsApp = async (product: any, quantity: number = 1, additionalInfo?: any, trackWhatsAppClick?: (context?: string) => void, onLoadingStart?: () => void) => {
  console.log('üõçÔ∏è [MOBILE DEBUG] sendSingleProductToWhatsApp called:', {
    productName: product.name,
    quantity: quantity,
    additionalInfo: additionalInfo,
    isMobile: isMobile(),
    isIOS: isIOS()
  });
  
  const total = product.price * quantity;
  
  // Gerar c√≥digo de verifica√ß√£o
  console.log('üîê [MOBILE DEBUG] Generating single product code...');
  const orderCode = await generateSingleProductCode(product, quantity, additionalInfo);
  
  if (!orderCode) {
    console.error('‚ùå [MOBILE DEBUG] Failed to generate order code for single product');
    return false;
  }
  console.log('‚úÖ [MOBILE DEBUG] Single product code generated:', orderCode);

  // Enviar email de confirma√ß√£o se o usu√°rio estiver logado
  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (user?.email) {
      console.log('üìß Sending single product email to:', user.email);
      await sendOrderCreatedEmail(
        user.email,
        user.user_metadata?.name || 'Cliente',
        orderCode
      );
    }
  } catch (err) {
    console.warn('üìß Single product email failed:', err);
  }
  
  const message = `Ol√°! Gostaria de comprar este produto da UTI DOS GAMES:

üì¶ *${product.name}*
üí∞ Pre√ßo: R$ ${product.price.toFixed(2)}
üìä Quantidade: ${quantity}
üíµ *Total: R$ ${total.toFixed(2)}*

üîê *C√≥digo de Verifica√ß√£o:*
${orderCode}

üìã *Copie o c√≥digo:*
${orderCode}

Aguardo retorno! üéÆ`;
  
  // Track WhatsApp click if tracking function is provided
  if (trackWhatsAppClick) {
    console.log('üìä Tracking single product WhatsApp click');
    trackWhatsAppClick('single_product_purchase');
  }

  const whatsappUrl = `https://wa.me/5527996882090?text=${encodeURIComponent(message)}`;
  console.log('üöÄ [MOBILE DEBUG] Opening single product WhatsApp:', {
    urlLength: whatsappUrl.length,
    messageIncludes: {
      productName: message.includes(product.name),
      verificationCode: message.includes(orderCode),
      total: message.includes(total.toFixed(2))
    }
  });
  
  // Usar fun√ß√£o robusta para abrir WhatsApp com loading
  openWhatsApp(whatsappUrl, onLoadingStart);
  
  console.log('‚úÖ [MOBILE DEBUG] Single product WhatsApp process completed');
  return orderCode;
};

// Fun√ß√£o simples para redirecionamento direto (para casos espec√≠ficos - SEM c√≥digo)
// NUNCA usa window.open() - funciona como link normal
export const openWhatsAppDirect = (phoneNumber: string, message: string) => {
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
  
  // Usar apenas location.href - funciona como clicar em um link
  // Nunca causa popup bloqueado
  window.location.href = whatsappUrl;
};

export const formatWhatsAppMessage = (cartItems: any[]) => {
  const itemsList = cartItems.map(item => 
    `‚Ä¢ ${item.product.name} (${item.size}${item.color ? `, ${item.color}` : ''}) - Qtd: ${item.quantity} - R$ ${(item.product.price * item.quantity).toFixed(2)}`
  ).join('\n');
  
  const total = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
  
  return `Ol√°! Gostaria de pedir os seguintes itens da UTI DOS GAMES:\n\n${itemsList}\n\n*Total: R$ ${total.toFixed(2)}*\n\nAguardo retorno! üéÆ`;
};
